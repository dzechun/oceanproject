<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fantechs.provider.wanbao.api.mapper.MiddleMaterialMapper">
    <resultMap id="BaseResultMap" type="com.fantechs.provider.wanbao.api.entity.MiddleMaterial">
        <id column="middle_material_id" jdbcType="VARCHAR" property="middleMaterialId"/>
        <result column="material_id" jdbcType="VARCHAR" property="materialId"/>
        <result column="material_code" jdbcType="VARCHAR" property="materialCode"/>
        <result column="material_name" jdbcType="VARCHAR" property="materialName"/>
        <result column="material_desc" jdbcType="VARCHAR" property="materialDesc"/>
        <result column="material_property" jdbcType="VARCHAR" property="materialProperty"/>
        <result column="modified_time" jdbcType="VARCHAR" property="modifiedTime"/>
        <result column="product_model_id" jdbcType="VARCHAR" property="productModelId"/>
        <result column="product_model_code" jdbcType="VARCHAR" property="productModelCode"/>
        <result column="voltage" jdbcType="VARCHAR" property="voltage"/>
    </resultMap>

    <select id="findMaterialData" parameterType="map" resultMap="BaseResultMap">
        SELECT msib.segment1                     AS material_code,
               msib.description                  AS material_name,
               msib.description                  AS material_desc,
               msib.ITEM_TYPE                    AS material_property,
               msib.last_update_date             AS modified_time,
               msib.WIP_SUPPLY_LOCATOR_ID        AS middle_material_id,
               (SELECT DISTINCT mde.element_value
                FROM mtl_descr_element_values mde
                WHERE mde.inventory_item_id = msib.inventory_item_id
                  AND mde.element_name = '客户型号') AS product_model_code,
               (SELECT DISTINCT mde.element_value
                FROM mtl_descr_element_values mde
                WHERE mde.inventory_item_id = msib.inventory_item_id
                  AND mde.element_name = '电压频率') AS voltage
        FROM mtl_system_items_b msib,
             mtl_item_categories_v t,
             fnd_common_lookups fc,
             po_buyers_val_v pbv
        WHERE msib.organization_id = 83
          AND msib.inventory_item_status_code = 'Active'
          AND msib.item_type = fc.lookup_code
          AND t.inventory_item_id = msib.inventory_item_id
          AND msib.buyer_id = pbv.employee_id(+)
          AND msib.ITEM_TYPE IN ('FG', 'SA')
          AND t.organization_id = 83
          AND fc.lookup_type = 'ITEM_TYPE'
          AND t.category_set_id = 1
          AND msib.last_update_date >= TO_DATE( '2021-08-05' , 'YYYY-MM-DD' )
    </select>

</mapper>