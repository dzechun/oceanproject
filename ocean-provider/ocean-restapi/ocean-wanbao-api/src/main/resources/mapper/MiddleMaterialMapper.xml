<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fantechs.provider.wanbao.api.mapper.MiddleMaterialMapper">
    <resultMap id="BaseResultMap" type="com.fantechs.provider.wanbao.api.entity.MiddleMaterial">
        <id column="middle_material_id" jdbcType="VARCHAR" property="middleMaterialId"/>
        <result column="material_id" jdbcType="VARCHAR" property="materialId"/>
        <result column="material_code" jdbcType="VARCHAR" property="materialCode"/>
        <result column="material_name" jdbcType="VARCHAR" property="materialName"/>
        <result column="material_desc" jdbcType="VARCHAR" property="materialDesc"/>
        <result column="material_property" jdbcType="VARCHAR" property="materialProperty"/>
        <result column="modified_time" jdbcType="VARCHAR" property="modifiedTime"/>
        <result column="product_model_id" jdbcType="VARCHAR" property="productModelId"/>
        <result column="product_model_code" jdbcType="VARCHAR" property="productModelCode"/>
        <result column="voltage" jdbcType="VARCHAR" property="voltage"/>
    </resultMap>

    <select id="findMaterialData" parameterType="map" resultMap="BaseResultMap">
        SELECT msib.segment1                     AS material_code,
               msib.description                  AS material_name,
               msib.description                  AS material_desc,
               msib.ITEM_TYPE                    AS material_property,
               msib.last_update_date             AS modified_time,
               msib.WIP_SUPPLY_LOCATOR_ID        AS middle_material_id,
               (SELECT DISTINCT mde.element_value
                FROM apps.mtl_descr_element_values mde
                WHERE mde.inventory_item_id = msib.inventory_item_id
                  AND mde.element_name = '客户型号') AS product_model_code,
               (SELECT DISTINCT mde.element_value
                FROM apps.mtl_descr_element_values mde
                WHERE mde.inventory_item_id = msib.inventory_item_id
                  AND mde.element_name = '电压频率') AS voltage
        FROM inv.mtl_system_items_b msib,
             apps.mtl_item_categories_v t,
             apps.fnd_common_lookups fc,
             apps.po_buyers_val_v pbv
        <where>
            msib.organization_id = 83
            AND msib.inventory_item_status_code = 'Active'
            AND msib.item_type = fc.lookup_code
            AND t.inventory_item_id = msib.inventory_item_id
            AND msib.buyer_id = pbv.employee_id(+)
            AND msib.ITEM_TYPE IN ('FG', 'SA')
            AND t.organization_id = 83
            AND fc.lookup_type = 'ITEM_TYPE'
            AND t.category_set_id = 1
            <if test="date != null and date != ''">
                AND msib.last_update_date >= TO_DATE( #{date} , 'YYYY-MM-DD' )
            </if>
        </where>
    </select>

    <insert id="save" parameterType="com.fantechs.provider.wanbao.api.entity.MiddleMaterial">
        INSERT INTO "K3WMS"."middle_material" ( "middle_material_id", "material_id", "material_code", "material_name", "material_desc", "voltage", "product_model_id", "product_model_code", "material_property", "modified_time" )
        VALUES
            ( #{middleMaterialId},
            #{materialId},
            #{materialCode},
            #{materialName},
            #{materialDesc},
            #{materialProperty},
            #{modifiedTime},
            #{productModelId},
            #{productModelCode},
            #{voltage} )
    </insert>
</mapper>