<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fantechs.provider.guest.eng.mapper.EngDataExportEngPackingOrderMapper">
  <resultMap id="BaseResultMapDto" type="com.fantechs.common.base.general.dto.restapi.EngDataExportEngPackingOrderDto">
    <!--
      WARNING - @mbg.generated com.fantechs.common.base.general.entity.eng.EngContractQtyOrder
    -->
    <id column="packing_order_id" jdbcType="VARCHAR" property="packingOrderId" />
    <result column="option2" jdbcType="VARCHAR" property="option2" />
    <result column="material_code" jdbcType="VARCHAR" property="materialCode" />
    <result column="location_num" jdbcType="VARCHAR" property="locationNum" />
    <result column="design_qty" jdbcType="VARCHAR" property="designQty" />
    <result column="surplus_qty" jdbcType="VARCHAR" property="surplusQty" />
    <result column="purchase_req_qty" jdbcType="VARCHAR" property="purchaseReqQty" />
    <result column="dominant_term_code" jdbcType="VARCHAR" property="dominantTermCode" />
    <result column="device_code" jdbcType="VARCHAR" property="deviceCode" />
    <result column="material_purpose" jdbcType="VARCHAR" property="materialPurpose" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
    <result column="record_time" jdbcType="VARCHAR" property="recordTime" />
    <result column="record_user" jdbcType="VARCHAR" property="recordUser" />
    <result column="material_name" jdbcType="VARCHAR" property="materialName" />
    <result column="spec" jdbcType="VARCHAR" property="spec" />
    <result column="unit_name" jdbcType="VARCHAR" property="unitName" />
    <result column="ch_qty" jdbcType="VARCHAR" property="chQty" />
  </resultMap>

  <sql id="Base_Column_List">
    epos.packing_order_id,
    ecqo.option2,
    ecqo.material_code,
    bm.material_name,
    eposdet.spec,
    eposdet.unit_name,
    ecqo.location_num,
    IFNULL(epro.design_qty,0) AS design_qty,
    IFNULL(epro.surplus_qty,0) AS surplus_qty,
    IFNULL(epro.purchase_req_qty,0) AS purchase_req_qty,
    ecqo.dominant_term_code,
    ecqo.device_code,
    ecqo.material_purpose,
    ecqo.remark,
    epos.modified_user_id AS record_user,
    epo.modified_time AS record_time,
    SUM(eposdet.qty) AS ch_qty
  </sql>

  <select id="findExportData" parameterType="map" resultMap="BaseResultMapDto">
    select <include refid="Base_Column_List"></include>
    FROM eng_packing_order_summary epos
    LEFT JOIN eng_packing_order epo ON epos.packing_order_id=epo.packing_order_id
    LEFT JOIN eng_packing_order_summary_det eposdet ON epos.packing_order_summary_id=eposdet.packing_order_summary_id
    LEFT JOIN base_material bm ON eposdet.material_id=bm.material_id
    LEFT JOIN eng_contract_qty_order ecqo ON epos.contract_code=ecqo.contract_code
    AND epos.device_code=ecqo.device_code
    AND bm.material_code=ecqo.material_code
    LEFT JOIN eng_purchase_req_order epro ON epro.option3=ecqo.option3

    <where>
      <if test="packingOrderId!=null and packingOrderId!=''">
        and epos.packing_order_id = #{packingOrderId}
      </if>
    </where>
    GROUP BY epos.packing_order_id,ecqo.option2,ecqo.material_code,bm.material_name,eposdet.spec,eposdet.unit_name,
    ecqo.location_num,epro.design_qty,epro.surplus_qty,epro.purchase_req_qty,
    ecqo.dominant_term_code,ecqo.device_code,ecqo.material_purpose,ecqo.remark,record_user,record_time
    HAVING ecqo.option2 IS NOT NULL
  </select>
</mapper>